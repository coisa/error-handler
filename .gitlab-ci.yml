stages:
  - lint
  - build
  - test

include:
  - template: Dependency-Scanning.gitlab-ci.yml
  - template: SAST.gitlab-ci.yml

lint:
  stage: lint
  image: php:7.2-alpine
  script:
    - find . ! -path "*/vendor/*" -name "*.php" -type f -print0 | xargs -P 10 -n 1 -0 php -l;

phpunit:
  stage: test
  image:
    name: docker/compose:1.24.1
    entrypoint: [""]
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: 127.0.0.1:2375
    APP_VERSION: $CI_BUILD_REF_SLUG
    COMPOSE_FILE: docker-compose.yml
  services:
    - docker:stable-dind
  script:
    - docker-compose build
    - docker-compose run --rm phpunit
  tags:
    - docker
